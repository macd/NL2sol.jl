
F77 = gfortran

# optimized and for shared library
#F77FLAGS = -O2 -shared -fPIC
#LINKFLAGS = -lc -lm -lnl2sol

# for test coverage we need the following and must
# also add the -lgcov flag to the linker.  Note also
# that without the -O2 flag we get a memory violation error
# On the provided test suite, we see an overall coverage 
# of 89.99%.  That can be generated by issuing the command
#  "gcov *.f ../fsrc/*.f" from the ftests directory.
# NOTE: 
# TODO: 
#  1: Make the following flags come from the top level Makefile
#  2: find better way to specify LD_LIBRARY_PATH
F77FLAGS = -O2 --coverage -fPIC
LINKFLAGS = -lc -lm -lnl2sol -lgcov --coverage

TEST = nlmain

all: $(TEST)

OBJECTS = nlmain.o ivvset.o madj.o madr.o nltest.o testj.o testr.o xinit.o

%.o: %.f
	$(F77) -c -o $@ $< $(F77FLAGS)

nlmain: $(OBJECTS)
	$(F77) $(OBJECTS) -L$$HOME/Nl2sol.jl/lib $(LINKFLAGS) -o nlmain;\
	export LD_LIBRARY_PATH=$$HOME/Nl2sol.jl/lib;\
	./nlmain > nl2sol_tests_output.txt

.PHONY: clean

clean:
	rm -f *.o *.gcda *.gcno *.gcov nlmain nl2sol_tests_output.txt
